<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="content-type" content="no-cache, must-revalidate" />
    <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT" />
    <title>checker</title>
</head>

<body translate="no" onunload="checker_close()">
    <div id="time" style="font-size: 50px; font-family: 'XHei Mono.Ubuntu';">Time: N/A</div><br>
    <div id="vid" style="font-size: 50px; font-family: 'XHei Mono.Ubuntu';">ID: N/A</div><br>
    <div id="vtitle" style="font-size: 50px; font-family: 'XHei Mono.Ubuntu';">Title: N/A</div><br>
    <div id="msg" style="font-size: 50px; font-family: 'XHei Mono.Ubuntu';">Msg: N/A</div><br>

    <script src="https://fastly.jsdelivr.net/npm/hacktimer@1.1.3/HackTimer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.7.1/jquery.js"></script>
    <script>
        const urlObj = new URL(window.location.href);
        const holodex_key = urlObj.searchParams.get("key");
        const channel_id = urlObj.searchParams.get("id");
        var quality = '';
        urlObj.searchParams.get("quality") ? quality = urlObj.searchParams.get("quality") : quality = '';

        var time = "";

        function UA_check() {
            var ua = navigator.userAgent
            var ua_regex = new RegExp('OBS');
            if (ua_regex.test(ua) == true) {
                document.getElementById('time').style.color = 'White';
                document.getElementById('vid').style.color = 'White';
                document.getElementById('vtitle').style.color = 'White';
                document.getElementById('msg').style.color = 'White';
                return;
            }
            else {
                document.getElementById('time').style.color = 'Black';
                document.getElementById('vid').style.color = 'Black';
                document.getElementById('vtitle').style.color = 'Black';
                document.getElementById('msg').style.color = 'Black';
                return;
            }
        }
        //var counter = setInterval(timer, 1000); //1000 will  run it every 1 second

        function timer() {
            count = count - 1;
            if (count <= 0) {
                clearInterval(counter);
                //counter ended, do something here
                return;
            }
            
        }

        function checker() {
            if (!channel_id) {
                $('#msg').text('Msg: 未提供ID');
                return 0;
            }

            if (!holodex_key) {
                $('#msg').text('Msg: 未提供Holodex密钥')
                return 0;
            }
            $.ajax({
                url: `https://holodex.net/api/v2/live?lang=zh&channel_id=${channel_id}&max_upcoming_hours=12`,
                type: `get`,
                headers: { "X-APIKEY": holodex_key },
                success: function (data) {
                    time = `${moment().utcOffset("+08:00").format("YYYY-M-D HH:mm:ss")}`;
                    $("#time").text(`Time: ${time}`);
                    if (data.length == 0) $('#msg').text('未检测到正在直播或12小时内开播的待机室')
                    if (data.length != 0) {
                        $("#vid").text(`ID: ${data[0].id}`);
                        $("#vtitle").text(`Title: ${data[0].title}`);
                        if (data[0].status == "live") $('#msg').text(`Msg: 检测到正在直播`)
                        if (data[0].status == "upcoming") $('#msg').html(`Msg: 检测到已创建待机室<br><br>Redirecting >>> Youtube<br>Quality: ${quality}`)
                        //console.log(`https://you-tube-auto.pages.dev/youtube.html?quality=${quality}&id=${data[0].id}`);
                        setTimeout(function () {
                            window.location.replace(`https://you-tube-auto.pages.dev/youtube.html?quality=${quality}&id=${data[0].id}`);
                        }, 3000)
                        //window.location.replace
                    }
                    return 0
                },
                timeout: 10000,
                error: function () {
                    $("#vid").text(`ID: N/A`);
                    $("#vtitle").text(`Title: N/A`);
                    $('#msg').text(`Msg: API访问超时`)
                }
            })
        }
        setInterval(w = function () {
            checker();
        }, 60000)
        checker();
        UA_check();
    </script>

</body>

</html>
